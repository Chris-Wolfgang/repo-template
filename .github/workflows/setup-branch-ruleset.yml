name: "Setup Branch Ruleset (One-Time)"

on:
  workflow_dispatch:

jobs:
  setup-ruleset:
    name: "setup-ruleset"
    runs-on: ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    permissions:
      contents: write
      administration: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if ruleset already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for existing ruleset..."
          
          # Query rulesets and filter by name using structured JSON querying
          if ! RULESET_NAME=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/rulesets \
            --jq '.[] | select(.name=="Protect main branch") | .name' 2>&1); then
            echo "âŒ Failed to fetch existing rulesets"
            echo "$RULESET_NAME"
            exit 1
          fi
          
          if [ -n "$RULESET_NAME" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Ruleset 'Protect main branch' already exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸  Ruleset 'Protect main branch' does not exist yet"
          fi

      - name: Create Branch Ruleset
        id: create_ruleset
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating branch ruleset..."
          
          # Temporarily disable exit on error to handle gh api failures properly
          set +e
          RESPONSE=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/rulesets \
            --input .github/ruleset-config.json 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Successfully created branch ruleset 'Protect main branch'"
            echo "$RESPONSE"
          else
            echo "âŒ Failed to create ruleset"
            echo "$RESPONSE"
            exit 1
          fi

      - name: Configure Git
        if: steps.check.outputs.exists == 'true' || steps.create_ruleset.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create cleanup branch
        if: steps.check.outputs.exists == 'true' || steps.create_ruleset.outcome == 'success'
        run: |
          TIMESTAMP=$(date +%s)
          BRANCH_NAME="cleanup/remove-ruleset-setup-${TIMESTAMP}"
          git checkout -b "$BRANCH_NAME"
          echo "CLEANUP_BRANCH=$BRANCH_NAME" >> "$GITHUB_ENV"

      - name: Remove setup files
        if: steps.check.outputs.exists == 'true' || steps.create_ruleset.outcome == 'success'
        run: |
          git rm --ignore-unmatch .github/ruleset-config.json
          git rm --ignore-unmatch .github/workflows/setup-branch-ruleset.yml

      - name: Commit cleanup changes
        if: steps.check.outputs.exists == 'true' || steps.create_ruleset.outcome == 'success'
        run: |
          git commit -m "chore: remove branch ruleset setup files

          - Removed .github/ruleset-config.json
          - Removed .github/workflows/setup-branch-ruleset.yml

          These files are no longer needed after the ruleset has been successfully created."

      - name: Push cleanup branch
        if: steps.check.outputs.exists == 'true' || steps.create_ruleset.outcome == 'success'
        run: |
          git push origin "$CLEANUP_BRANCH"

      - name: Create cleanup pull request
        if: steps.check.outputs.exists == 'true' || steps.create_ruleset.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.check.outputs.exists }}" == "true" ]; then
            PR_BODY=$(cat <<'EOF'
          ## ðŸŽ‰ Branch Ruleset Already Configured!

          This pull request cleans up the one-time setup files that are no longer needed.

          ### âœ… What Was Found

          The branch protection ruleset **"Protect main branch"** already exists in this repository. 
          
          **Expected Configuration** (please verify in Settings â†’ Rules â†’ Rulesets):
          
          The template's default ruleset includes:
          - Pull requests required before merging
          - 5 required status checks (CI/CD stages + security scans)
          - Branches must be up to date before merging
          - Conversation resolution required
          - Stale reviews dismissed when new commits are pushed
          - CodeQL security scanning (blocks on High+ severity findings)
          - Force pushes blocked on main branch
          - Branch deletion prevented for main
          - Repository admins can bypass these rules
          
          **Note:** If you manually modified the ruleset, your current configuration may differ from the template defaults listed above.

          ### ðŸ—‘ï¸ Files Being Removed

          This PR removes the following setup files:
          - `.github/ruleset-config.json` - Ruleset configuration template
          - `.github/workflows/setup-branch-ruleset.yml` - One-time setup workflow

          ### ðŸ¤” Why Remove These Files?

          Since the branch protection ruleset already exists in your repository settings, these setup files are no longer needed. The ruleset will persist even after these files are deleted. Removing them helps keep your repository clean and prevents the setup workflow from running unnecessarily in the future.

          ### âœ… How to Verify the Ruleset Still Exists

          After merging this PR, you can verify the ruleset is still active by:
          1. Going to **Settings â†’ Rules â†’ Rulesets** in your repository
          2. You should see "Protect main branch" in the list
          3. Click on it to view all the configured rules

          ### ðŸ“ Next Steps

          1. **Review this PR** to confirm the files being removed
          2. **Merge this PR** to complete the cleanup
          3. The branch protection will remain active and enforce all configured rules

          ---

          **Note:** This PR was automatically created by the branch ruleset setup workflow to clean up files that are no longer needed.
          EOF
            )
          else
            PR_BODY=$(cat <<'EOF'
          ## ðŸŽ‰ Branch Ruleset Successfully Created!

          This pull request cleans up the one-time setup files that are no longer needed.

          ### âœ… What Was Accomplished

          The following branch protection rules have been successfully configured for the **main** branch:

          - âœ… **Pull requests required** before merging
          - âœ… **Required status checks** (must pass before merging):
            - Stage 1: Linux Tests (.NET 5.0-10.0) + Coverage Gate
            - Stage 2: Windows Tests (.NET 5.0-10.0, Framework 4.6.2-4.8.1)
            - Stage 3: macOS Tests (.NET 6.0-10.0)
            - Security Scan (DevSkim)
            - Security Scan (CodeQL)
          - âœ… **Branches must be up to date** before merging
          - âœ… **Conversation resolution required** before merging
          - âœ… **Stale reviews dismissed** when new commits are pushed
          - âœ… **CodeQL security scanning** (blocks on High+ severity findings)
          - âœ… **Force pushes blocked** on main branch
          - âœ… **Branch deletion prevented** for main
          - âœ… **Repository admins can bypass** these rules

          ### ðŸ—‘ï¸ Files Being Removed

          This PR removes the following setup files:
          - `.github/ruleset-config.json` - Ruleset configuration template
          - `.github/workflows/setup-branch-ruleset.yml` - One-time setup workflow

          ### ðŸ¤” Why Remove These Files?

          These files were only needed for the initial setup. The branch protection ruleset now exists in your repository settings and will persist even after these files are deleted. Removing them helps keep your repository clean and prevents the setup workflow from running unnecessarily in the future.

          ### âœ… How to Verify the Ruleset Still Exists

          After merging this PR, you can verify the ruleset is still active by:
          1. Going to **Settings â†’ Rules â†’ Rulesets** in your repository
          2. You should see "Protect main branch" in the list
          3. Click on it to view all the configured rules

          ### ðŸ“ Next Steps

          1. **Review this PR** to confirm the files being removed
          2. **Merge this PR** to complete the cleanup
          3. The branch protection will remain active and enforce all configured rules

          ---

          **Note:** This PR was automatically created by the branch ruleset setup workflow. The workflow cannot automatically merge this PR because it respects the branch protection rules it just createdâ€”this ensures you review the changes before the setup files are permanently removed.
          EOF
            )
          fi

          gh pr create \
            --title "chore: Clean up branch ruleset setup files" \
            --body "$PR_BODY" \
            --base main \
            --head "$CLEANUP_BRANCH"

      - name: Output summary
        if: steps.check.outputs.exists == 'true' || steps.create_ruleset.outcome == 'success'
        run: |
          if [ "${{ steps.check.outputs.exists }}" == "true" ]; then
            cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          # â„¹ï¸ Branch Ruleset Already Exists

          The branch protection ruleset **"Protect main branch"** already exists in this repository.

          ## ðŸ›¡ï¸ Protections Configured

          - âœ… Pull requests required before merging
          - âœ… 5 required status checks (CI/CD stages + security scans)
          - âœ… Branches must be up to date before merging
          - âœ… Conversation resolution required
          - âœ… CodeQL security scanning (High+ severity blocks merges)
          - âœ… Force pushes blocked
          - âœ… Branch deletion prevented
          - âœ… Admin bypass enabled

          ## ðŸ”— View Ruleset

          You can view and modify the ruleset in your repository settings:
          **Settings â†’ Rules â†’ Rulesets â†’ "Protect main branch"**

          ## ðŸ“‹ Next Steps

          1. **Review the cleanup PR** that was automatically created
          2. **Merge the PR** to remove the setup files (`.github/ruleset-config.json` and this workflow file)
          3. The branch protection will remain active after the files are removed

          The ruleset is already active and will continue to enforce all configured rules on the main branch! ðŸŽ‰
          EOF
          else
            cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          # âœ… Branch Ruleset Setup Complete!

          The branch protection ruleset **"Protect main branch"** has been successfully created.

          ## ðŸ›¡ï¸ Protections Enabled

          - âœ… Pull requests required before merging
          - âœ… 5 required status checks (CI/CD stages + security scans)
          - âœ… Branches must be up to date before merging
          - âœ… Conversation resolution required
          - âœ… CodeQL security scanning (High+ severity blocks merges)
          - âœ… Force pushes blocked
          - âœ… Branch deletion prevented
          - âœ… Admin bypass enabled

          ## ðŸ”— View Ruleset

          You can view and modify the ruleset in your repository settings:
          **Settings â†’ Rules â†’ Rulesets â†’ "Protect main branch"**

          ## ðŸ“‹ Next Steps

          1. **Review the cleanup PR** that was automatically created
          2. **Merge the PR** to remove the setup files (`.github/ruleset-config.json` and this workflow file)
          3. The branch protection will remain active after the files are removed

          The ruleset is now active and will enforce all configured rules on the main branch! ðŸŽ‰
          EOF
          fi
