# PR validation workflow - Linux only with coverage gating
# Linux tests with 90% coverage requirement

name: PR Checks (Linux Only)

permissions:
  contents: read
  
on:
  pull_request: 
    branches: 
      - main

    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  # ============================================================================
  # Linux - .NET Core/5+ Tests with Coverage Gate
  # ============================================================================
  test-linux-core: 
    name: "Linux Tests (.NET 5.0-10.0) + Coverage Gate"
    runs-on:  ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Fix for .NET 5.0 on Ubuntu 22.04+ - install libssl1.1
      - name: Install OpenSSL 1.1 for .NET 5.0
        run: |
          wget https://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb
          sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2_amd64.deb

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            5.0.x
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore and build (exclude .NET Framework 4.x projects)
        run: |
          echo "Finding all projects in solution..."
          
          # Get list of all projects from solution file
          if [ -f "*.sln" ]; then
            sln_file=$(ls *.sln | head -n 1)
            echo "Using solution file: $sln_file"
          fi
          
          # Find all .csproj, .vbproj, and .fsproj files
          # Exclude those with 'dotnet4' or 'DotNet4' in the path (case-insensitive)
          projects=$(find . -type f \( -name "*.csproj" -o -name "*.vbproj" -o -name "*.fsproj" \) | grep -iv "dotnet4")
          
          if [ -z "$projects" ]; then
            echo "No projects found!"
            exit 1
          fi
          
          echo "=========================================="
          echo "Projects to build (excluding .NET Framework 4.x):"
          echo "=========================================="
          echo "$projects"
          echo ""
          
          # Restore each project
          echo "Restoring projects..."
          for proj in $projects; do
            echo "Restoring: $proj"
            dotnet restore "$proj" || exit 1
          done
          
          echo ""
          echo "Building projects..."
          # Build each project
          for proj in $projects; do
            echo "Building: $proj"
            dotnet build "$proj" --no-restore --configuration Release || exit 1
          done
          
          echo ""
          echo "✅ All compatible projects built successfully"

      - name: Run tests with coverage (.NET Core 5.0 - 10.0)
        run: |
          # Find all test projects
          test_projects=$(find ./tests -type f -name "*.csproj")
          
          if [ -z "$test_projects" ]; then
            echo "❌ No test projects found in ./tests directory!"
            exit 1
          fi
          
          echo "=========================================="
          echo "Found test projects:"
          echo "=========================================="
          echo "$test_projects"
          echo ""
          
          # Test each framework individually to ensure all are tested
          frameworks=(net5.0 net6.0 net7.0 net8.0 net9.0 net10.0)
          
          for test_proj in $test_projects; do
            echo "=========================================="
            echo "Testing project: $test_proj"
            echo "=========================================="
            
            for fw in "${frameworks[@]}"; do
              echo "Testing framework: $fw"
              
              dotnet test "$test_proj" \
                --configuration Release \
                --framework "$fw" \
                --collect:"XPlat Code Coverage" \
                --results-directory "./TestResults" \
                --logger "console;verbosity=minimal" || exit 1
            done
            echo ""
          done

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: |
          reportgenerator \
            -reports:"TestResults/**/coverage.cobertura.xml" \
            -targetdir:"CoverageReport" \
            -reporttypes:"Html;TextSummary;MarkdownSummaryGithub;CsvSummary"

      - name: Enforce 90% coverage threshold
        run: |
          if [ ! -f CoverageReport/Summary.txt ]; then
            echo "❌ Coverage report not generated!"
            exit 1
          fi

          echo "Coverage Summary:"
          cat CoverageReport/Summary.txt
          echo ""
          
          # Validate that the report contains expected content
          if ! grep -q "Summary" CoverageReport/Summary.txt; then
            echo "❌ Coverage report format is invalid!"
            exit 1
          fi
          
          failed_projects=""
          threshold=90
          
          while read -r line; do
            # Match lines with module names and percentages
            if echo "$line" | grep -qE '^[^ ].*[0-9]+%$' && ! echo "$line" | grep -q '^Summary'; then
              module=$(echo "$line" | awk '{print $1}')
              percent=$(echo "$line" | awk '{print $NF}' | tr -d '%')
              
              echo "Checking module: '$module' - Coverage: ${percent}%"
              
              if [ "$percent" -lt "$threshold" ]; then
                echo "  ❌ FAIL: Below ${threshold}% threshold"
                failed_projects="$failed_projects $module (${percent}%)"
              else
                echo "  ✅ PASS: Meets ${threshold}% threshold"
              fi
            fi
          done < CoverageReport/Summary.txt

          if [ -n "$failed_projects" ]; then
            echo ""
            echo "=========================================="
            echo "❌ COVERAGE GATE FAILED"
            echo "=========================================="
            echo "Projects below ${threshold}% coverage: $failed_projects"
            echo ""
            echo "Stage 1 failed. Windows, macOS, and .NET Framework tests will NOT run."
            exit 1
          else
            echo ""
            echo "=========================================="
            echo "✅ COVERAGE GATE PASSED"
            echo "=========================================="
            echo "All projects meet ${threshold}% coverage threshold."
          fi

      - name: Upload Linux coverage results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-linux
          path: |
            TestResults/
            CoverageReport/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            src/**/bin/Release
            tests/**/bin/Release

  # ============================================================================
  # Security Scan (Runs in parallel with tests)
  # ============================================================================
  security-scan:
    name: "Security Scan (DevSkim)"
    runs-on: ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DevSkim CLI
        run: dotnet tool install --global Microsoft.CST.DevSkim.CLI

      - name: Run DevSkim security scan
        run: |
          devskim analyze \
            --source-code . \
            --file-format text \
            --output-file devskim-results.txt \
            -E \
            --ignore-rule-ids DS176209 \
            --ignore-globs "**/api/**,**/CoverageReport/**,**/TestResults/**"

      - name: Display security scan results
        if: always()
        run: |
          if [ -f devskim-results.txt ]; then
            echo "=========================================="
            echo "DevSkim Security Scan Results"
            echo "=========================================="
            cat devskim-results.txt
            echo ""
            
            if grep -qi "error\|critical\|high" devskim-results.txt; then
              echo "⚠️ Security issues detected - review required"
            else
              echo "✅ No critical security issues found"
            fi
          else
            echo "✅ No security issues found"
          fi

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: devskim-results
          path: devskim-results.txt
          if-no-files-found: warn
